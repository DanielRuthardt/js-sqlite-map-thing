<html>
<body>
<ul id="list"></ul>
<script>

out = document.getElementById('list')

function Parser(data) {
    this.data = data;
    this.ofs = 0;
    this.length = data.length;
    this.get_int = function(intsize) {
        value = 0;
        while(intsize--)
            value = (value<<8) + this.data.charCodeAt(this.ofs++);
        return value;
    }
    this.get_str = function() {
        length = this.get_int(2);
        if(length==0xffff)
            return '';
        value = this.data.substr(this.ofs,length)
        this.ofs += length;
        return value;
    }
    this.skip_str = function(numstrs) {
        while(numstrs--) {
            length = this.get_int(2);
            if(length<0xffff)
                this.ofs += length;
        }
    }
    this.skip = function(size) {
        this.ofs += size;
    }
    this.bytes = function(size) {
        value = this.data.substr(this.ofs,size);
        this.ofs += size;
        return value;
    }
    this.more = function() {
        return this.ofs < this.length;
    }
    this.seek = function(ofs) {
        this.ofs = ofs;
    }
}

function load_loc_db(reader) {
    return function(e) {
        var data = new Parser(reader.result);
        out.innerHTML += '<li>db is '+data.length+' bytes</li>';
        var magic = data.bytes(15);
        out.innerHTML += '<li>magic is '+magic+'</li>';
        if(("SQLite format 3"!=magic)||(0!=data.bytes(1).charCodeAt(0)))
            throw "location db has bad magic ("+magic+")";
        var page_size = data.get_int(2)*256;
        out.innerHTML += '<li>'+page_size+'</li>';
        data.seek(100);
        
    }
}

function load_mbdx(reader,files,target) {
    return function(e) {
        var data = new Parser(reader.result);
        if("mbdx" != data.bytes(4))
            throw "manifest MBDX has bad magic";
        data.skip(6);
        var output = [];
        var file = null;
        while(data.more()) {
            var fileID = "";
            for(var i=0; i<20; i++) {
                var hex = data.bytes(1).charCodeAt(0).toString(16);
                while(hex.length < 2)
                    hex = '0'+hex;
                fileID += hex;
            }
            if(target == data.get_int(4)+6) {
                out.innerHTML += '<li>'+fileID+'</li>';
                file = files[fileID];
                break;
            }
            data.skip(2);
        }
        if(file == null)
            throw "Cannot resolve Library/Caches/locationd/consolidated.db";
        db = new FileReader();
        db.onload = SQR.loadfile(db);
		db.onerror = function(e) { alert(e) }
        db.readAsBinaryString(file);
    }
}

function load_mbdb(reader,files) {
    return function(evt) {
        var data = new Parser(evt.target.result);
        out.innerHTML += '<li>manifest is '+
            data.length+' bytes</li>';
        if("mbdb" != data.bytes(4))
            throw "manifest MBDB has bad magic";
        data.skip(2);
        var locationd;
        while(data.more()) {
            var start = data.ofs;
            data.skip_str(1);
            if("Library/Caches/locationd/consolidated.db" == data.get_str()) {
                locationd = start;
                break;
            }
            data.skip_str(3);
            data.skip(4*9+3);
            var num_props = data.get_int(1);
            for(var i=0; i<num_props; i++) {
                data.skip_str(2);
            }
        }
        if(locationd == null)
            throw "Library/Caches/locationd/consolidated.db is not in index"
        var mbdx = new FileReader();
        mbdx.onloadend = load_mbdx(mbdx,files,locationd);
		mbdx.onerror = function(e) { alert(e) }
        mbdx.readAsBinaryString(files["Manifest.mbdx"]);
    }
}

function handleFileSelect(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    // go through all the files indexing them by name
    var input = evt.dataTransfer.files;
    document.getElementById('list').innerHTML = '<li>... please wait ...</li>';
    var files = []
    for(var i = 0, f; f = input[i]; i++)
        files[f.name] = f;
    if(("Manifest.mbdb" in files)&&("Manifest.mbdx" in files)) {
        document.getElementById('list').innerHTML = '<li>manifest found!</li>';
        var mbdb = new FileReader();
        mbdb.onload = load_mbdb(mbdb,files);
		mbdb.onerror = function(e) { alert(e) }
        mbdb.readAsBinaryString(files["Manifest.mbdb"]);
    } else {
    	    document.getElementById('list').innerHTML = '<li>no manifest found!</li>';
    }
}

function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    document.getElementById('list').innerHTML = '<li>... drop here to process ...</li>';
}

document.addEventListener('dragover', handleDragOver, false);
document.addEventListener('drop', handleFileSelect, false);

</script></body>
</html>