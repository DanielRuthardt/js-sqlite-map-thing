<html>
	<head>
		<title>Plot your iPhone Tracking Data on Google maps</title>
		<link rel="stylesheet" href="2.css" type="text/css" media="screen" /> 
		<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.5.2.min.js" type="text/javascript"></script>
		<script src="plist.js" type="text/javascript"></script>
		<script src="sql.js" type="text/javascript"></script>
		<script src="pack.js" type="text/javascript"></script>
		 <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
		<script type="text/javascript">

		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-22971528-1']);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();

		</script>
	</head>
	
	<body>	
	<div id="airlock">
		<div class="o" id="map_canvas"></div>
	</div>
	<div id="infos">
	<div class="box" id="instructions_and_stuff">
			<span id="chrome">
			<h3>Select your backup folder</h3><input type="file"  multiple="true" webkitdirectory directory multiple mozdirectory id="fileselector"> 
			<p><ul>
                <li>Mac: <em>/[User]/Library/Application Support/MobileSync/Backup/[Newest Folder]/</em></li>
                <li>Windows: <em>[User]\Application Data\Apple Computer\MobileSync\Backup\[Newest Folder]</em></li>
 			</ul>
			</span>
			<p>You can also drag&drop a consolidated.db file anywhere on here, if you have it.</p>
			<b>No data is sent to any server, anywhere. All data remains on your computer</b>
	</div>
	<div class="box" style="display: none;" id="wait">This should take, at most, a few seconds. If it takes longer than that, it didn't work for some reason or another. Check out the <a href="https://github.com/markolson/js-sqlite-map-thing/issues">issues on github</a> and see if it's a known problem with your osx/browser/technique.</div>
	</div>
	<div id="footer"><a href="https://github.com/markolson">@mark_olson</a> & <a href="https://github.com/williame">William Edwards</a>
		&dash; <a href="http://markolson.github.com/js-sqlite-map-thing/">code on github</a>
		&dash; <b>All data remains on your computer.</b>
		&dash; <b>Works best with Chrome.</b>
	</div>
	
	<script type="text/javascript">	
	$(function(){ 
		if (window.File && window.FileReader && window.FileList && window.Blob) { } else {
		 alert("This probably won't work for you (try chrome), but you're still free to try.");
		}
		
	   var latlng = new google.maps.LatLng(50, -50);
	    var myOptions = {
	      zoom: 3,
	      center: latlng,
	      mapTypeId: google.maps.MapTypeId.ROADMAP
	    };
	    GOOG_map = new google.maps.Map(document.getElementById('map_canvas'), myOptions);
	    
		$.strPad = function(i,l,s) {
			var o = i.toString();
			if (!s) { s = '0'; }
			while (o.length < l) {
				o = s + o;
			}
			return o;
		};

		SQR = new Sqlite3Reader();
		PACK = new JSPack();

		$('#fileselector').change(function(e) {
			i = this.files;
			handleFileSelect(i);
		});

		$(document).bind('sqlready', function(e) {
			data = SQR.read_table('CellLocation');
			$('#wait').hide();
			$('#map_canvas').removeClass('o');

			var latlngbounds = new google.maps.LatLngBounds( );
			$.each(data, function(i,row) { 
				if(row[5] < 0.01 && row[5] > -0.01 && row[6] < 0.01 && row[6] < 0.01) { return }
				var myLatLng = new google.maps.LatLng(row[5], row[6]);
				latlngbounds.extend( myLatLng );
				var image = 'beachflag.png';
				var beachMarker = new google.maps.Marker({
			      position: myLatLng,
			      map: GOOG_map
			  });
			
			})
			GOOG_map.fitBounds (latlngbounds);
		})

		function handleFileDrop(evt) {
		    evt.stopPropagation();
		    evt.preventDefault();
		    var files = evt.dataTransfer.files; // FileList object.
		    handleFileSelect(files);
		}

		function handleDragOver(evt) {
			evt.stopPropagation();
			evt.preventDefault();		
		}

		document.addEventListener('dragover', handleDragOver, false);
	 	document.addEventListener('drop', handleFileDrop, false);

		function handleFileSelect(input) {
		    $('#wait, #instructions_and_stuff').toggle();
		    var files = [];
		    for(var i = 0, f; f = input[i]; i++) {
		        files[f.name] = f;
		    }
		    if("consolidated.db" in files) {
		        var db = new FileReader();
		        db.onload = SQR.loadfile(db);
		        db.onerror = function(e) { error("There was an error while reading the consolidated.db file") }
		        db.readAsBinaryString(files["consolidated.db"]);
		    } else if(("Manifest.mbdb" in files) && ("Manifest.mbdx" in files)) {
		        var mbdb = new FileReader();
		        mbdb.onload = load_mbdb(mbdb, files);
		        mbdb.onerror = function(e) { error("There was an error while reading the files") }
		        mbdb.readAsBinaryString(files["Manifest.mbdb"]);
		    } else {
				error("No suitable file could be found. You should be adding either a file called <em>consolidated.db</em> or a folder with the files <em>Manifest.mbdb</em> and <em>Manifest.mbdx</em>")
		    }
		}

		function error(m) {
			$('#wait').html(m);
		}
	});
	function lilog(t) {
		//$('#list').append($('<li />', {text: t}));
	}
	</script>
	</body>	
</html>